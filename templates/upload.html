{% extends 'base.html' %}
{% block title %}Upload Your CV - Polish My CV{% endblock %}
{% block extra_head %}
{% endblock %}
{% block content %}
    <div class="main-section" id="mainSection">
        <div class="left-col" id="leftCol">
            <div class="upload-card">
                <div>
                    <div class="hero-headline">Fix your resume using AI</div>
                    <div class="hero-sub">Find out if your resume fits the job you're applying for</div>
                </div>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 12px; cursor: pointer;">
                        <input type="file" name="cv_file" id="cv_file" accept=".pdf,.docx" style="display: none;">
                        <div id="uploadText">
                            <i class="fas fa-upload" style="font-size: 48px; color: var(--red-accent); margin-bottom: 10px;"></i>
                            <div style="font-size: 20px; font-weight: bold;">Click to upload your resume</div>
                            <div style="font-size: 14px; color: #666;">PDF or DOCX files only</div>
                        </div>
                    </div>
                </form>
                <div>
                    <div class="job-label">Enter the job you are applying for</div>
                    <input class="job-select" id="jobSelect" list="jobRoles" placeholder="e.g. Senior Software Engineer" autocomplete="off">
                    <datalist id="jobRoles">
                        <option value="Senior Software Engineer">
                        <option value="Product Manager">
                        <option value="Data Scientist">
                        <option value="UX Designer">
                        <option value="Other">
                    </datalist>
                </div>
                <div>
                    <div class="job-desc-row">
                        <div class="job-desc-label">Job Description</div>
                        <span class="generate-link" id="generateLink">(Generate)</span>
                    </div>
                    <textarea class="job-desc-area" id="jobDesc" placeholder="Input Job Description. Write down the requirements for the job you are applying for. For best results, you should copy–paste the JD from LinkedIn or Career Website. Or you can auto–generate by clicking the button above."></textarea>
                </div>
                <button class="review-btn" id="reviewBtn">Review my resume &rarr;</button>
            </div>
        </div>
        <div class="right-col" id="rightCol">
            <section class="review-illustration-section">
                <div class="illustration" id="illustrationBlock">
                    <div class="illustration-img emoji-circle" style="margin-bottom: 24px;">
                        <span id="emojiCycler" style="font-size: 3rem; transition: opacity 0.4s; display: inline-block;">📄</span>
                    </div>
                    <div class="illustration-text">Upload your resume to get personalized recommendations.</div>
                </div>
            </section>
            <div id="reviewResults"></div>
        </div>
        <div id="reviewOverlay" class="review-overlay" style="display:none;">
            <div class="review-animation" id="reviewAnimation">
                <div class="checkmark-circle">
                    <svg viewBox="0 0 52 52"><circle cx="26" cy="26" r="25" fill="none"/><path d="M14 27l7 7 16-16" fill="none"/></svg>
                </div>
                <div class="reviewed-text">Reviewed!</div>
            </div>
            <div id="fullReviewPanel" style="display:none;"></div>
        </div>
    </div>
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2023 Polish My CV. All rights reserved.</span>
        </div>
    </footer>
{% endblock %}
{% block extra_scripts %}
    <script>
        // Replace the old upload button code with this new implementation
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('cv_file');
        const uploadText = document.getElementById('uploadText');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        let extractedText = '';

        fileInput.addEventListener('change', async (e) => {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                uploadText.innerHTML = `
                    <i class="fas fa-check" style="font-size: 48px; color: #28ca42; margin-bottom: 10px;"></i>
                    <div style="font-size: 20px; font-weight: bold;">${fileName}</div>
                    <div style="font-size: 14px; color: #666;">Click to change file</div>
                `;
                // Upload the file and get extracted text
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                try {
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Upload failed');
                    }

                    const uploadData = await uploadResponse.json();

                    if (uploadData.success && uploadData.extracted_text) {
                        extractedText = uploadData.extracted_text;
                    } else {
                        extractedText = '';
                        alert(uploadData.error || 'Failed to extract text from CV.');
                    }
                } catch (err) {
                    extractedText = '';
                    alert('Error uploading CV. Please try again.');
                    console.error('Upload error:', err);
                }
            }
        });

        // Drag and drop support
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--red-accent)';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            fileInput.files = e.dataTransfer.files;
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                uploadText.innerHTML = `
                    <i class="fas fa-check" style="font-size: 48px; color: #28ca42; margin-bottom: 10px;"></i>
                    <div style="font-size: 20px; font-weight: bold;">${fileName}</div>
                    <div style="font-size: 14px; color: #666;">Click to change file</div>
                `;
            }
        });
        // Gemini job description generation
        document.getElementById('generateLink').onclick = async function() {
            const role = document.getElementById('jobSelect').value.trim();
            if (!role) {
                alert('Please enter a job role first.');
                return;
            }
            const jobDescArea = document.getElementById('jobDesc');
            jobDescArea.value = 'Generating job description for "' + role + '"...';
            try {
                const response = await fetch('/generate-job-desc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                const data = await response.json();
                if (data && data.description) {
                    jobDescArea.value = data.description;
                } else {
                    jobDescArea.value = '';
                    alert('Could not generate job description.');
                }
            } catch (e) {
                jobDescArea.value = '';
                alert('Error generating job description.');
            }
        };
        // Review my resume button handler
        document.getElementById('reviewBtn').onclick = async function() {
            const role = document.getElementById('jobSelect').value.trim();
            const jobDesc = document.getElementById('jobDesc').value.trim();
            if (!extractedText) {
                alert('Please upload a valid CV file first.');
                return;
            }
            const reviewBtn = document.getElementById('reviewBtn');
            reviewBtn.innerText = 'Reviewing...';
            reviewBtn.disabled = true;
            const reviewResults = document.getElementById('reviewResults');
            reviewResults.style.display = 'none';
            reviewResults.innerHTML = '';
            document.querySelector('.right-col').classList.remove('review-active');
            try {
                console.log('Starting CV review...');
                const response = await fetch('/api/review-cv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cv_text: extractedText,
                        job_description: jobDesc
                    })
                });
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Review API Response:', data);
                console.log('Data has success:', 'success' in data);
                console.log('Data has redirect_url:', 'redirect_url' in data);
                
                if (data.error) {
                    alert('Error: ' + data.error);
                } else if (data.success && data.redirect_url) {
                    // Redirect to the dedicated review page
                    console.log('Redirecting to:', data.redirect_url);
                    console.log('About to redirect...');
                    window.location.href = data.redirect_url;
                    return; // Exit early to prevent fallback code
                } else {
                    console.log('Falling back to old review display');
                    console.log('data.success:', data.success);
                    console.log('data.redirect_url:', data.redirect_url);
                    document.getElementById('illustrationBlock').style.display = 'none';
                    let html = '';
                    html += `
                        <div class="cv-review-panel">
                            <div class="cv-review-score">
                                <span id="cvScore">${data.rating ?? '--'}</span>
                                <div class="cv-review-score-label">Score</div>
                            </div>
                            <div class="cv-review-sections">
                                <div class="cv-review-section strengths">
                                    <div class="cv-review-section-title"><i class="fas fa-thumbs-up"></i> Top 5 Strengths</div>
                                    <ul>${(data.strengths || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                                <div class="cv-review-section weaknesses">
                                    <div class="cv-review-section-title"><i class="fas fa-thumbs-down"></i> Worst 5 Weaknesses</div>
                                    <ul>${(data.weaknesses || []).slice(0, 5).map(w => `<li>${w}</li>`).join('')}</ul>
                                </div>
                                <div class="cv-review-section suggestions">
                                    <div class="cv-review-section-title"><i class="fas fa-lightbulb"></i> Top Suggestions</div>
                                    <ul>${(data.suggestions || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                            </div>
                        </div>
                    `;
                    // Hide left and right columns, show overlay
                    document.getElementById('leftCol').style.display = 'none';
                    document.getElementById('rightCol').style.display = 'none';
                    document.getElementById('reviewOverlay').style.display = 'flex';
                    document.getElementById('reviewAnimation').style.display = 'flex';
                    document.getElementById('fullReviewPanel').style.display = 'none';
                    // After 1.5s, hide animation and show review
                    setTimeout(() => {
                        document.getElementById('reviewAnimation').style.display = 'none';
                        document.getElementById('fullReviewPanel').innerHTML = `
                            <div class="review-overlay-content">
                                <div class="review-left">
                                    <div class="full-review-card">
                                        <div class="cv-review-score">
                                            <span id="cvScore">${data.rating ?? '--'}</span>
                                            <div class="cv-review-score-label">Score</div>
                                        </div>
                                        <div class="cv-review-section strengths">
                                            <div class="cv-review-section-title"><i class="fas fa-thumbs-up"></i> Top 5 Strengths</div>
                                            <ul>${(data.strengths || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                        </div>
                                        <div class="cv-review-section weaknesses">
                                            <div class="cv-review-section-title"><i class="fas fa-thumbs-down"></i> Worst 5 Weaknesses</div>
                                            <ul>${(data.weaknesses || []).slice(0, 5).map(w => `<li>${w}</li>`).join('')}</ul>
                                        </div>
                                        <div class="cv-review-section suggestions">
                                            <div class="cv-review-section-title"><i class="fas fa-lightbulb"></i> Top Suggestions</div>
                                            <ul>${(data.suggestions || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                        </div>
                                        <button class="full-review-close" onclick="window.location.reload()">Upload another CV</button>
                                    </div>
                                </div>
                                <div class="review-right">
                                    <div class="review-cta-title">Generate your perfect resume, today</div>
                                    <div class="review-cta-desc">Transform your CV into a stunning, job-winning resume in seconds. Our AI-powered tool makes it easy!</div>
                                    <button class="review-cta-btn" onclick="generateImprovedResume()">Generate Resume</button>
                                </div>
                            </div>
                        `;
                        document.getElementById('fullReviewPanel').style.display = 'flex';
                    }, 1500);

                    if (data.rating !== undefined && document.getElementById('gaugeScore')) {
                        document.getElementById('gaugeScore').textContent = data.rating;
                    }
                    // Debug: log API response and generated HTML
                    console.log('Review API response:', data);
                    console.log('Review HTML:', html);
                }
            } catch (e) {
                alert('Error reviewing CV.');
            } finally {
                reviewBtn.innerText = 'Review my resume &rarr;';
                reviewBtn.disabled = false;
            }
        };
        // Generate improved resume function
        async function generateImprovedResume() {
            const generateBtn = document.querySelector('.review-cta-btn');
            const originalText = generateBtn.textContent;
            
            // Show loading state
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/generate-improved-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Redirect to the improved resume preview page
                    window.location.href = `/improved-resume-preview/${data.session_id}`;
                } else {
                    alert('Error generating improved resume: ' + (data.error || 'Unknown error'));
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating improved resume. Please try again.');
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }

        // Emoji cycling animation
        const emojis = ["📄", "🤖", "✨", "📝", "💼"];
        let emojiIndex = 0;
        const emojiSpan = document.getElementById("emojiCycler");
        setInterval(() => {
            emojiSpan.style.opacity = 0;
            setTimeout(() => {
                emojiIndex = (emojiIndex + 1) % emojis.length;
                emojiSpan.textContent = emojis[emojiIndex];
                emojiSpan.style.opacity = 1;
            }, 400);
        }, 5000);
    </script>
{% endblock %}
